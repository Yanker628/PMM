# PMM åšå¸‚å•†ç³»ç»Ÿ - MVP åŸå‹è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv0.1 ä½œè€…ï¼šYanker Jang  æ—¥æœŸï¼š2025-07-15

---

## ğŸ¯ ç›®æ ‡

æ„å»ºä¸€ä¸ªåŸºäº Binance Testnet çš„æœ€å°å¯ç”¨åšå¸‚å•†ç³»ç»Ÿï¼ˆPMMï¼‰ï¼Œå…·å¤‡ï¼š

- 3 æ¡£æŒ‚å•é€»è¾‘ï¼ˆä¸­é—´ä»·ä¸Šä¸‹åç§»ï¼‰
- å¼‚æ­¥éé˜»å¡ç»“æ„ï¼Œç¡®ä¿ç¨³å®šæ€§å’Œé«˜å¯ç”¨
- æ”¯æŒæŒ‡æ ‡é‡‡é›†ã€é£æ§å¤„ç†ã€é”™è¯¯æ¢å¤
- æ˜“äºæ‹“å±•ã€è°ƒè¯•ã€éƒ¨ç½²

---

## ğŸ“ é¡¹ç›®ç»“æ„

```text
quant_pmm/
â”œâ”€â”€ main.py                     # ç¨‹åºå…¥å£
â”œâ”€â”€ config.yaml                 # ç­–ç•¥é…ç½®
â”œâ”€â”€ .env                        # APIå¯†é’¥ç­‰æ•æ„Ÿæ•°æ®ï¼ˆä¸å…¥ç‰ˆæœ¬ï¼‰
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ engine.py               # ä¸»æ‰§è¡Œè°ƒåº¦å™¨
â”‚   â”œâ”€â”€ state.py                # å…±äº«çŠ¶æ€ç»“æ„
â”‚   â”œâ”€â”€ market.py               # è¡Œæƒ…è®¢é˜…ä¸å¤„ç†å™¨
â”‚   â”œâ”€â”€ order.py                # æŒ‚å•ç®¡ç†å™¨
â”‚   â”œâ”€â”€ risk.py                 # é£æ§æ¨¡å—
â”‚   â”œâ”€â”€ logger.py               # æ—¥å¿—é‡‡é›†å™¨
â”‚   â””â”€â”€ recovery.py             # å®¹é”™ä¸å¼‚å¸¸ç›‘æ§å™¨
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ config_loader.py        # åŠ è½½ .env + yaml
â”‚   â”œâ”€â”€ http.py                 # Binance REST å°è£…
â”‚   â””â”€â”€ ws.py                   # WebSocket å°è£…
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ test_order.py           # æŒ‚å•æ¨¡å—æµ‹è¯•
â”‚   â”œâ”€â”€ test_risk.py            # é£æ§æ¨¡å—æµ‹è¯•
â”‚   â””â”€â”€ ...                     # æ›´å¤šæ¨¡å—å•æµ‹
â””â”€â”€ logs/
    â””â”€â”€ metrics-YYYYMMDD.csv    # æ¯æ—¥æŒ‡æ ‡æ—¥å¿—
```

---

## âš™ï¸ é…ç½®ç»“æ„

### `.env`

```env
# åˆçº¦æµ‹è¯•ç½‘apiï¼Œåç»­ä½¿ç”¨å®ç›˜
BINANCE_API_KEY=xxxx
BINANCE_SECRET_KEY=xxxx
EXCHANGE_ENV=testnet
LISTEN_KEY_REFRESH_INTERVAL=1800
```

### `config.yaml`

```yaml
strategy_name: simple_pmm
symbol: BTCUSDT # åç»­å¢åŠ å¤šç§
leverage: 1
initial_capital: 200    # 200USDTåˆå§‹èµ„é‡‘
max_net_position_ratio: 0.5 # æœ€å¤§æŒä»“å æ¯”50%

order_config:
  levels: 3
  quantity_per_order_usdt: 10
  price_offset_percent: 0.25

refresh_config:
  orderbook_refresh_interval: 5
  risk_check_interval: 1

logging:
  log_to_csv: true
  log_directory: ./logs
  log_level: info
```

---

## â›“ï¸ æ‰§è¡Œå¼•æ“ä¼ªä»£ç 

```python
async def run_engine():
    tasks = [
        MarketDataWorker(),
        OrderManager(),
        RiskController(),
        LoggerWorker(),
        RecoveryManager()
    ]
    await asyncio.gather(*tasks)
```

---

## ğŸ”„ æ¨¡å—åŠŸèƒ½è¯´æ˜ï¼ˆå«ä¼ªä»£ç ï¼‰

### MarketDataWorker

- é€šè¿‡ WebSocket è®¢é˜… `bookTicker`
- è®¡ç®—ä¸­é—´ä»·å¹¶ç¼“å­˜

```python
while True:
    msg = await ws.recv()
    data = json.loads(msg)
    SharedState.mark_price = (bid + ask) / 2
```

### OrderManager

- æ¯ 5 ç§’å–æ¶ˆæ‰€æœ‰æŒ‚å•ï¼Œé‡æ–°æŒ‚ 3 æ¡£å•

```python
await cancel_all_orders()
for level in [1,2,3]:
    await send_order(level, mid_price)
```

### RiskController

- æ¯ç§’æ£€æŸ¥æŒä»“æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼Œè‹¥è¶…å‡ºåˆ™å¹³ä»“å¹¶æš‚åœç­–ç•¥

```python
if abs(position) > max_pos:
    await close_position()
    SharedState.strategy_paused = True
```

### LoggerWorker

- æ¯ç§’é‡‡é›†æŒ‡æ ‡å†™å…¥ CSV

```python
metrics = collect_metrics()
write_to_csv(metrics)
```

### RecoveryManager

- æ–­ç½‘é‡è¿ï¼Œæ¥å£é‡è¯•ï¼Œæ¨¡å—å¼‚å¸¸é‡å¯

```python
if ws.disconnected():
    await reconnect_ws()
```

---

## ğŸ“Š æŒ‡æ ‡è®°å½•æ ¼å¼ï¼ˆCSVï¼‰

| å­—æ®µ           | è¯´æ˜              |
| ------------ | --------------- |
| timestamp    | æœ¬åœ° ISO æ—¶é—´æˆ³      |
| instance\_id | å®ä¾‹IDï¼ˆå¦‚ï¼šmvp\_v1ï¼‰ |
| env          | ç¯å¢ƒï¼ˆtestnetï¼‰     |
| metric\_name | æŒ‡æ ‡åç§°            |
| value        | æŒ‡æ ‡æ•°å€¼            |
| unit         | å•ä½ï¼ˆms/usdt/btcï¼‰ |
| symbol       | BTCUSDT         |
| side         | buy/sell/-      |
| level        | æ¡£ä½ï¼ˆ1/2/3ï¼‰       |
| sub\_type    | é™„åŠ å­ç±»å‹           |
| details      | é™„åŠ å¤‡æ³¨            |

---

## ğŸ“ˆ æµç¨‹å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰

```mermaid
flowchart TD
    Start([å¯åŠ¨]) --> LoadConfig
    LoadConfig --> StartWS
    StartWS --> RunEngine
    RunEngine --> MarketData
    RunEngine --> OrderLoop
    RunEngine --> RiskLoop
    RunEngine --> Logger
    RunEngine --> Recovery
    Recovery -->|å¼‚å¸¸| RestartModule
    RiskLoop -->|è¶…ä»“| PauseOrder
```

---

## ğŸ•“ æ—¶åºå›¾ï¼ˆæ ¸å¿ƒäº¤æ˜“æµç¨‹ï¼‰

```mermaid
sequenceDiagram
    participant EX as Binance
    participant WS as WebSocket
    participant MKT as MarketDataWorker
    participant ORD as OrderManager
    participant RSK as RiskController

    WS->>MKT: æ”¶åˆ° bookTicker
    MKT->>ORD: æ›´æ–°ä¸­é—´ä»·
    loop æ¯5ç§’
        ORD->>EX: å–æ¶ˆæŒ‚å•
        ORD->>EX: æŒ‚3æ¡£è®¢å•
    end
    loop æ¯1ç§’
        RSK->>EX: æŸ¥è¯¢æŒä»“
        alt è¶…ä»“
            RSK->>EX: å¸‚ä»·å¯¹å†²å¹³ä»“
            RSK->>ORD: æ ‡è®°æš‚åœæŒ‚å•
        end
    end
```

---

## âœ… æ€»ç»“

è¯¥ MVP å…·å¤‡å®Œæ•´è¿è¡Œéª¨æ¶ï¼šå¼‚æ­¥æ¨¡å—ã€é…ç½®ç®¡ç†ã€æŒ‡æ ‡é‡‡é›†ã€é£æ§å®¹é”™ï¼Œå…·å¤‡å‘å®ç›˜ç­–ç•¥æ‹“å±•çš„åŸºç¡€ã€‚åç»­å¯é€æ­¥å¢åŠ ï¼š

- æ›´æ™ºèƒ½çš„ç­–ç•¥é€»è¾‘ï¼ˆä»·æ ¼ä¿¡å·ã€é¢„æµ‹æ¨¡å‹ï¼‰
- å¤šäº¤æ˜“å¯¹æ”¯æŒã€å¤šå®ä¾‹ååŒ
- æ¥å…¥ Grafana å¯è§†åŒ–å’Œç­–ç•¥å›æµ‹ç³»ç»Ÿ

---

## ğŸ“š æ¨¡å—æ¥å£è¯´æ˜ä¸ç”¨ä¾‹

### 1. é…ç½®åŠ è½½æ¨¡å—ï¼ˆutils/config_loader.pyï¼‰

**åŠŸèƒ½**ï¼šåŠ è½½ .env å’Œ config.yamlï¼Œç»Ÿä¸€æä¾›å…¨å±€é…ç½®å¯¹è±¡ã€‚

**ä¸»è¦æ¥å£ï¼š**
```python
from utils.config_loader import get_config

config = get_config()
print(config["strategy_name"])
print(config.get("symbol"))
```

- `get_config(env_path, yaml_path)`ï¼šåŠ è½½å¹¶è¿”å› Config å¯¹è±¡ã€‚
- `Config` å¯¹è±¡æ”¯æŒå±æ€§è®¿é—®å’Œä¼˜å…ˆçº§ï¼ˆyaml > env > é»˜è®¤å€¼ï¼‰ã€‚
- å¼‚å¸¸ï¼šConfigLoaderErrorï¼ŒåŠ è½½å¤±è´¥æ—¶æŠ›å‡ºã€‚

**å‘½ä»¤è¡Œç”¨ä¾‹ï¼š**
```shell
python utils/config_loader.py
# è¾“å‡ºï¼šé…ç½®åŠ è½½æˆåŠŸï¼ <Config yaml=... env=...>
```

---

### 2. å…¨å±€çŠ¶æ€æ¨¡å—ï¼ˆcore/state.pyï¼‰

**åŠŸèƒ½**ï¼šç»´æŠ¤å…¨å±€å…±äº«çŠ¶æ€ï¼Œä¾›å„å¼‚æ­¥æ¨¡å—è¯»å†™ã€‚

**ä¸»è¦æ¥å£ï¼š**
```python
from core.state import shared_state

shared_state.mark_price = 30000.0
shared_state.position = 0.01
shared_state.strategy_paused = True

# çº¿ç¨‹å®‰å…¨æ‰¹é‡æ›´æ–°
shared_state.safe_update(mark_price=31000.0, position=0.02)
```

- `shared_state`ï¼šå…¨å±€å•ä¾‹ï¼Œå­—æ®µåŒ…æ‹¬ mark_priceã€positionã€strategy_pausedã€last_order_timeã€last_risk_checkã€‚
- `safe_update(**kwargs)`ï¼šçº¿ç¨‹å®‰å…¨åœ°æ‰¹é‡æ›´æ–°çŠ¶æ€ã€‚

**å‘½ä»¤è¡Œç”¨ä¾‹ï¼š**
```shell
python core/state.py
# è¾“å‡ºï¼šåˆå§‹çŠ¶æ€ã€æ›´æ–°åã€çº¿ç¨‹å®‰å…¨æ›´æ–°åçš„çŠ¶æ€
```

---
